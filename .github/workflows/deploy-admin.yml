name: Deploy Application (Admin Only)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - production
      force_deploy:
        description: 'Force deployment (bypass checks)'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip tests (emergency only)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  deployments: write
  actions: read

env:
  NODE_VERSION: '20'

jobs:
  verify-branch:
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.check.outputs.branch }}
      can_deploy: ${{ steps.check.outputs.can_deploy }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify branch and environment
        id: check
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          
          echo "Current branch: $CURRENT_BRANCH"
          echo "Target environment: $ENVIRONMENT"
          
          case "$ENVIRONMENT" in
            "dev")
              if [ "$CURRENT_BRANCH" != "dev" ]; then
                echo "âŒ Must be on dev branch to deploy to dev environment"
                echo "can_deploy=false" >> $GITHUB_OUTPUT
                exit 1
              fi
              ;;
            "production")
              if [ "$CURRENT_BRANCH" != "main" ]; then
                echo "âŒ Must be on main branch to deploy to production"
                echo "can_deploy=false" >> $GITHUB_OUTPUT
                exit 1
              fi
              
              # Check if last merge was from release branch
              if ! git log --oneline --merges | head -1 | grep -q "release/"; then
                echo "âš ï¸ Warning: Last merge was not from a release branch"
                if [ "${{ github.event.inputs.force_deploy }}" != "true" ]; then
                  echo "âŒ Production deployment requires release branch merge"
                  echo "can_deploy=false" >> $GITHUB_OUTPUT
                  exit 1
                fi
              fi
              ;;
          esac
          
          echo "can_deploy=true" >> $GITHUB_OUTPUT
          echo "branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT

  deploy:
    needs: verify-branch
    if: needs.verify-branch.outputs.can_deploy == 'true'
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}
      url: ${{ github.event.inputs.environment == 'production' && 'https://uiforge.com' || 'https://dev.uiforge.com' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Verify admin access
        run: |
          echo "ðŸ” Verifying admin access for deployment..."
          AUTHORIZED_ADMINS="LucasSantana-Dev"
          CURRENT_USER="${{ github.actor }}"
          
          if [[ "$AUTHORIZED_ADMINS" == *"$CURRENT_USER"* ]]; then
            echo "âœ… User $CURRENT_USER is authorized for deployment"
          else
            echo "âŒ User $CURRENT_USER is not authorized to deploy"
            echo "ðŸš¨ This workflow requires admin privileges"
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Run tests (unless skipped or forced)
        if: github.event.inputs.skip_tests != 'true' && github.event.inputs.force_deploy != 'true'
        run: |
          echo "ðŸ§ª Running tests..."
          npm run test

      - name: Run linting (unless forced)
        if: github.event.inputs.force_deploy != 'true'
        run: |
          echo "ðŸ” Running linting..."
          npm run lint

      - name: Run type checking (unless forced)
        if: github.event.inputs.force_deploy != 'true'
        run: |
          echo "ðŸ“ Running type checking..."
          npm run type-check

      - name: Build application
        run: |
          echo "ðŸ“¦ Building application..."
          npm run build

      - name: Security scan (production only)
        if: github.event.inputs.environment == 'production' && github.event.inputs.force_deploy != 'true'
        run: |
          echo "ðŸ”’ Running security scan..."
          npm audit --audit-level high

      - name: Deploy to environment
        run: |
          echo "ðŸš€ Deploying to ${{ github.event.inputs.environment }}..."
          
          case "${{ github.event.inputs.environment }}" in
            "dev")
              echo "ðŸŒ Deploying to dev.uiforge.com"
              # Add actual dev deployment commands here
              echo "ðŸ“¦ Dev deployment files ready"
              ;;
            "production")
              echo "ðŸŒ Deploying to uiforge.com"
              # Add actual production deployment commands here
              echo "ðŸ“¦ Production deployment files ready"
              ;;
          esac

      - name: Health check
        run: |
          echo "ðŸ” Running health check..."
          DEPLOY_URL="${{ github.event.inputs.environment == 'production' && 'https://uiforge.com' || 'https://dev.uiforge.com' }}"
          
          # Wait for deployment to be ready
          sleep 30
          
          # Check if the site is accessible
          if curl -f "$DEPLOY_URL/health" > /dev/null 2>&1; then
            echo "âœ… Health check passed for $DEPLOY_URL"
          else
            echo "âš ï¸ Health check failed, but deployment may still be processing"
            echo "ðŸ”— Check the deployment at: $DEPLOY_URL"
          fi

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ needs.verify-branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ github.event.inputs.environment == 'production' && 'https://uiforge.com' || 'https://dev.uiforge.com' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "**âš ï¸ Force Deploy:** Yes (checks bypassed)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ github.event.inputs.skip_tests }}" == "true" ]; then
            echo "**âš ï¸ Tests Skipped:** Yes (emergency deployment)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY