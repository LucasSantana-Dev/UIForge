name: Main Branch Force-Only Enforcement

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  enforce-force-only:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if push was forced
        id: check-force
        run: |
          # Check if this was a force push
          if [[ "${{ github.event.forced }}" == "true" ]]; then
            echo "‚úÖ Force push detected - ALLOWED"
            echo "force_push=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Normal push detected - NOT ALLOWED on main branch"
            echo "force_push=false" >> $GITHUB_OUTPUT
            echo "üö® Main branch only accepts force pushes with --force"
            echo "üí° Use './scripts/push-main.sh' for proper main branch pushes"
            exit 1
          fi
      
      - name: Verify force push authorization
        if: steps.check-force.outputs.force_push == 'true'
        run: |
          echo "üîê Verifying force push authorization..."
          
          # Check if the pusher is authorized to force push
          AUTHORIZED_USERS="LucasSantana-Dev"
          PUSHER="${{ github.actor }}"
          
          if [[ "$AUTHORIZED_USERS" == *"$PUSHER"* ]]; then
            echo "‚úÖ User $PUSHER is authorized to force push"
          else
            echo "‚ùå User $PUSHER is not authorized to force push main branch"
            exit 1
          fi
      
      - name: Log force push
        if: steps.check-force.outputs.force_push == 'true'
        run: |
          echo "üìù Force push logged:"
          echo "- User: ${{ github.actor }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Timestamp: $(date)"
          echo "- Repository: ${{ github.repository }}"

  block-normal-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.event.forced == 'false'
    steps:
      - name: Block normal push
        run: |
          echo "‚ùå NORMAL PUSHES TO MAIN BRANCH ARE NOT ALLOWED"
          echo "üö® Use 'git push --force' to push to main branch"
          echo "üìã Main branch requires force pushes to ensure deliberate deployment"
          exit 1

  pr-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR to main
        run: |
          echo "üìã Pull request to main branch detected"
          echo "‚úÖ PRs are allowed for review and approval"
          echo "üîÑ After merge, use force push to deploy to production"