name: Deploy Web App (Admin Only)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      force_deploy:
        description: 'Force deployment (bypass checks)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  deployments: write
  actions: read

env:
  NODE_VERSION: '20'

jobs:
  deploy-web:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}
      url: ${{ github.event.inputs.environment == 'production' && 'https://siza.com' || 'https://preview.siza.com' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Verify admin access
        run: |
          echo "ðŸ” Verifying admin access for deployment..."
          AUTHORIZED_ADMINS="LucasSantana-Dev"
          CURRENT_USER="${{ github.actor }}"
          
          if [[ "$AUTHORIZED_ADMINS" == *"$CURRENT_USER"* ]]; then
            echo "âœ… User $CURRENT_USER is authorized for deployment"
          else
            echo "âŒ User $CURRENT_USER is not authorized to deploy"
            echo "ðŸš¨ This workflow requires admin privileges"
            exit 1
          fi

      - name: Install dependencies
        working-directory: ./apps/web
        run: npm ci

      - name: Run tests (unless forced)
        if: github.event.inputs.force_deploy != 'true'
        working-directory: ./apps/web
        run: |
          echo "ðŸ§ª Running tests..."
          npm run test

      - name: Run linting (unless forced)
        if: github.event.inputs.force_deploy != 'true'
        working-directory: ./apps/web
        run: |
          echo "ðŸ” Running linting..."
          npm run lint

      - name: Run type checking (unless forced)
        if: github.event.inputs.force_deploy != 'true'
        working-directory: ./apps/web
        run: |
          echo "ðŸ“ Running type checking..."
          npm run type-check

      - name: Build application
        working-directory: ./apps/web
        run: |
          echo "ðŸ“¦ Building application..."
          npm run build

      - name: Install Wrangler
        run: |
          echo "ðŸ”§ Installing Wrangler CLI..."
          npm install -g wrangler

      - name: Deploy to Cloudflare Pages
        working-directory: ./apps/web
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸŒ Deploying to ${{ github.event.inputs.environment }}..."
          
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "ðŸš€ Deploying to production..."
            wrangler pages deploy .next --env production
          else
            echo "ðŸ‘€ Deploying to preview..."
            wrangler pages deploy .next --env preview
          fi

      - name: Health check
        run: |
          echo "ðŸ” Running health check..."
          DEPLOY_URL="${{ github.event.inputs.environment == 'production' && 'https://siza.com' || 'https://preview.siza.com' }}"
          
          # Wait for deployment to be ready
          sleep 30
          
          # Check if the site is accessible
          if curl -f "$DEPLOY_URL/health" > /dev/null 2>&1; then
            echo "âœ… Health check passed for $DEPLOY_URL"
          else
            echo "âš ï¸ Health check failed, but deployment may still be processing"
            echo "ðŸ”— Check the deployment at: $DEPLOY_URL"
          fi

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ github.event.inputs.environment == 'production' && 'https://siza.com' || 'https://preview.siza.com' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY