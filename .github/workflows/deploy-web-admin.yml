name: Deploy Web App (Admin Only)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      force_deploy:
        description: 'Force deployment (bypass checks)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  deployments: write
  actions: read

jobs:
  deploy-web:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ github.event.inputs.environment == 'production' && 'https://siza.com' || 'https://preview.siza.com' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Verify admin access
        env:
          CURRENT_USER: ${{ github.actor }}
        run: |
          AUTHORIZED_ADMINS="LucasSantana-Dev"
          if [[ "$AUTHORIZED_ADMINS" == *"$CURRENT_USER"* ]]; then
            echo "User $CURRENT_USER is authorized for deployment"
          else
            echo "User $CURRENT_USER is not authorized to deploy"
            exit 1
          fi

      - name: Verify branch for production
        if: github.event.inputs.environment == 'production'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          if [ "$CURRENT_BRANCH" != "main" ]; then
            echo "Production deployments must be from the main branch (current: $CURRENT_BRANCH)"
            exit 1
          fi

      - run: npm ci --legacy-peer-deps

      - name: Run quality checks
        if: github.event.inputs.force_deploy != 'true'
        run: |
          npm run lint
          npm run type-check
          npm test

      - name: Build with OpenNext
        working-directory: apps/web
        run: npx opennextjs-cloudflare build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_ENABLE_STRIPE_BILLING: ${{ vars.NEXT_PUBLIC_ENABLE_STRIPE_BILLING }}
          NEXT_PUBLIC_ENABLE_USAGE_LIMITS: ${{ vars.NEXT_PUBLIC_ENABLE_USAGE_LIMITS }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}

      - name: Stub unused WASM and remove _redirects
        run: |
          printf '\x00\x61\x73\x6d\x01\x00\x00\x00' > node_modules/next/dist/compiled/@vercel/og/resvg.wasm
          printf '\x00\x61\x73\x6d\x01\x00\x00\x00' > node_modules/next/dist/compiled/@vercel/og/yoga.wasm
          rm -f apps/web/.open-next/assets/_redirects 2>/dev/null || true

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/web
          command: deploy --keep-vars

      - name: Deployment summary
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
          DEPLOY_USER: ${{ github.actor }}
          DEPLOY_BRANCH: ${{ github.ref_name }}
          DEPLOY_SHA: ${{ github.sha }}
          FORCE_DEPLOY: ${{ github.event.inputs.force_deploy }}
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $DEPLOY_ENV" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** $DEPLOY_USER" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** $DEPLOY_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** $DEPLOY_SHA" >> $GITHUB_STEP_SUMMARY
          if [ "$FORCE_DEPLOY" == "true" ]; then
            echo "**Force Deploy:** Yes (checks bypassed)" >> $GITHUB_STEP_SUMMARY
          fi
